= Microsoft Account Login Procedure tricks Katalon WebUI.click keyword to throw StaleElementReferenceException

- @author kazurayam
- @date Dec 2024

== Problem to solve

In the Katalon Community forum, there was a topic

- https://forum.katalon.com/t/stale-element-not-found-is-this-relate-to-using-same-object/97973["Stale element not found, is this relate to using same Object?"]

originated by jirayu.s in Sep 2023. He wanted to develop a Test Case script in Katalon Studio that automates the login procedure in to Microsoft Account. Microsoft 365, Microsoft OneDrive, Azure DevOps --- these services require you to have a https://account.microsoft.com/account["Microsoft Account"]. Everytime you use those cloud services, you need to pass the login procedure. If you are to create a Web UI test in Katalon Studio against those Microsoft cloud services, you must be able to automate the login procedure. jirayu.s wanted to do it, but encountered a problem:  **`WebUI.click(testobject)` keyword threw a StaleElementReferenceException**. 13 people (including me, kazurayam) were involved in the topic and posted their comments. But eventually nobody could find the reason why jirayu.s's test got a StaleElementReferenceException.

On the other hand, in Dec 2024, I made another topic

- https://forum.katalon.com/t/reproducing-selenium-staleelementreferenceexception-in-katalon-studio/157936/[Reproducing Selenium StaleElementReferenceException in Katalon Studio]

in this post, I argumed that some of the Katalon built-in keywords have defects that occasionally cause `StaleElementReferenceException`. The list of problematic keywords includes:

1. `WebUI.waitForElementNotClickable(testobject, timeout)`
2. `WebUI.waitForElementNotHasAttribute(testobject, attributeName, timeout)`
3. `WebUI.waitForElementClickable(testobject, timeout)`

However, at that time of investigation, I could not reproduce a case where `WebUI.click(testobject)` keyword throws `StaleElementReferenceException` as jirayu.s reported.

Now, I went back to the jirayu's topic. I had a careful look into the Microsoft Account Login procedure. Now I believe I have found out a definitive resolution to his problem. Let me explain it.

== Test Cases/MSAccountLogin_failing --- reproducing the original issue

Let me demonstrate a Test Case that can reproduce the jirayu.s' problem.

Here I assume you have already have a Microsoft Account for you. You want to create a Execution Profile "myMicrosoftAccount" which includes 3 GlobalVariables: `ACCOUNT`, `EMAIL` and `PASSWD`.

image::https://kazurayam.github.io/StaleElementReferenceExceptionReproduction/images/myMicrosoftAccount.png[]

I made a Test Case script https://github.com/kazurayam/StaleElementReferenceExceptionReproduction/blob/main/Scripts/MSAccountLogin_failing/Script1734339841468.groovy[Test Case/MSAccountLogin_failing], which was derived from the script by jirayu.s.

[source,groovy]
----
include::../Scripts/MSAccountLogin_failing/Script1734339841468.groovy[]
----

Please try running this script with the `myMicrosoftAccout` Profile applied.

The script opens a browser window, navigate to a URL

- https://dev.azure.com/${GlobalVariable.ACCOUNT}

As you well know, this is the entry point for Microsoft Azure DevOps. You will be redirected to a view with a title "Sign in". I will call this view as "the Sign-in view" for short.

image::https://kazurayam.github.io/StaleElementReferenceExceptionReproduction/images/MsAccountLoginProcedure_1_Signin.png[]

The test case script will send the value of `GlobalVariable.EMAIL` into the `<input @name='loginfmt'>` element, which will be accepted. The script will click the Next button. The browser window will transition to the view with a title "Enter password". I will call this view as "the Enter-password view" for short.

image::https://kazurayam.github.io/StaleElementReferenceExceptionReproduction/images/MsAccountLoginProcedure_2_Password_SERE.png[]

Of course, I expect the value of `GlobalVariable.PASSWD` is sent into the `<input name='passwd'>` element.

However, the script throws an StaleElementReferenceException and stops. You can have a look at a sample output in the console:

- https://kazurayam.github.io/StaleElementReferenceExceptionReproduction/MsAccountLoginProcedure_console.txt[console output]

You can find that a `StaleElementReferenceException` was thrown by the line #38:

```
WebUI.click(passwd)
```

This was a surprise for me.

== Problem analysis.

=== WebUI.click keyword is a stateful keyword

I checked the source code of `WebUI.click` keyword of Katalon Studio v9.0.0, which contains the following fragment:

- https://kazurayam.github.io/StaleElementReferenceExceptionReproduction/10.0.0/source/com.kms.katalon.core.webui/com/kms/katalon/core/webui/keyword/builtin/ClickKeyword.groovy[ClickKeyword source]

Let me dictate this source:

1. The WebUI.click keyword internally calls a method `clickUntilSuccessWithTimeout(WebElement,long,int)` which contains a `while` loop.

2. The loop continues while `webElement.click()` throws `ElementClickInterceptedException`.

3. The loop terminates when `webElement.click()` throws an Exception other than `ElementClickInterceptedException`, for example a `StaleElementReferenceException`.

To my surprise, the `WebUI.click` keyword is "stateful", is not a "stateless" keyword.

=== The "Sign in" view also contains an invisible "Password" field as well as the "Password" view



[source,html]
----
...
    <input id="i0118" data-testid="i0118" name="passwd" placeholder="Password" type="password" maxlength="120" aria-label="Enter the password for kazuaki.urayama@gmail.com" aria-describedby="loginHeader " class="" autocomplete="current-password" value="" style="border-color: rgb(102, 102, 102);">
...
----


[source,html]
----
...
    <input name="passwd" type="password" id="i0118"
        data-bind="moveOffScreen, textInput: passwordBrowserPrefill"
        class="moveOffScreen" tabindex="-1" aria-hidden="true">
...
----

[source,css]
----
.moveOffScreen {
    position:fixed; bottom:0; right:0;
    height:0 !important;
    width:0 !important;
    overflow:hidden; opacity:0; filter:alpha(opacity=0)
}
----


image::https://kazurayam.github.io/StaleElementReferenceExceptionReproduction/images/MsAccountLoginProcedure_3_Success.png[]

